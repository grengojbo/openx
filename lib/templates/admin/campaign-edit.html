{*<!--

+---------------------------------------------------------------------------+
| OpenX v${RELEASE_MAJOR_MINOR}                                             |
| ======${RELEASE_MAJOR_MINOR_DOUBLE_UNDERLINE}                             |
|                                                                           |
| Copyright (c) 2003-2008 OpenX Limited                                     |
| For contact details, see: http://www.openx.org/                           |
|                                                                           |
| This program is free software; you can redistribute it and/or modify      |
| it under the terms of the GNU General Public License as published by      |
| the Free Software Foundation; either version 2 of the License, or         |
| (at your option) any later version.                                       |
|                                                                           |
| This program is distributed in the hope that it will be useful,           |
| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
| GNU General Public License for more details.                              |
|                                                                           |
| You should have received a copy of the GNU General Public License         |
| along with this program; if not, write to the Free Software               |
| Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA |
+---------------------------------------------------------------------------+
$Id$
-->*}
{*debug*}

{if $showAddBannerLink}
    <img src='{$assetPath}/images/icon-banner-new.gif' border='0' align='absmiddle'>&nbsp; 
    <a href='banner-edit.php?clientid={$clientid}&campaignid={$campaignid}' accesskey='{t str=keyAddNew}'>{t str=AddBanner_Key}</a>
    {phpAds_ShowBreak}
{/if}
<br/><br/>

{include file=form/general-errors.html errors=$campaignErrors title=ErrorEditingCampaign text=UnableToChangeCampaign}

{*campaign status change form*}
{include file=form/form.html form=$statusForm}
{*/campaign status change form*}

{*campaign form*}
{include file=form/form.html form=$campaignForm}
{*/campaign form*}


<script language='javascript' type='text/javascript' src='{$assetPath}/js/datecheck.js'></script>
<script language='javascript' type='text/javascript' src='numberFormat.js.php?lang={$language}'></script>

<script type="text/javascript">
    <!--
    var calendarBeginOfWeek = {$calendarBeginOfWeek};
    
    var impressions_delivered = {$impressionsDelivered};
    var clicks_delivered = {$clicksDelivered};
    var conversions_delivered = {$conversionsDelivered};
    
    var strCampaignWarningNoTargetMessage = '{$strCampaignWarningNoTargetMessage}';
    var strCampaignWarningNoWeightMessage ='{$strCampaignWarningNoWeightMessage}';
    
{if $adDirectEnabled}
    var centralImpressionsRemaining = 3000; // REAL DATA GOES HERE
    var centralClicksRemaining = 600; //REAL DATA GOES HERE
    
	{literal}
	$(document).ready(function() {
	    initCampaignStatus();
	});

	function insufficientNumberCheck(remainingLocalCount, remainingCentralCount, remainingCentralId)
	{
		var $remainingCentral = $("#" + remainingCentralId);
		if ($remainingCentral.lenght == 0) {
		  return;
		}
		markInsufficient(remainingLocalCount < remainingCentralCount, remainingCentralId);
	}

    function markInsufficient(insufficient, remainingCentralId)
    {
		var $remainingCentral = $("#" + remainingCentralId);
		var $remainingCentralHelpLink = $("#" + remainingCentralId + "HelpLink");

		if (insufficient) {
			$remainingCentral.addClass("sts-insufficient");
			$remainingCentralHelpLink.show().css("display", "inline");
		}
		else {
			$remainingCentral.removeClass("sts-insufficient");
			$remainingCentralHelpLink.hide();
		}
    }
    {/literal}
{/if}

{literal}	
  //setup form  
  $(document).ready(function() {
    phpAds_formUnlimitedCheck('unlimitedimpressions', 'impressions');
    phpAds_formUnlimitedCheck('unlimitedclicks', 'clicks');
{/literal}    
    {* Conditionally display conversion tracking*}
{if $conversionsEnabled}
    phpAds_formUnlimitedCheck('unlimitedconversions', 'conversions');
{/if}
    
{literal}    
    $(":input[name='rd_impr_bkd']").click(function() { 
        phpAds_formUnlimitedClick('unlimitedimpressions', 'impressions', 'openadsRemainingImpressions'); 
        return true; 
    });
    $(":input[name='rd_click_bkd']").click(function() { 
        phpAds_formUnlimitedClick('unlimitedclicks', 'clicks', 'openadsRemainingClicks'); 
        return true;
    });
    $(":input[name='rd_conv_bkd']").click(function() { 
        phpAds_formUnlimitedClick('unlimitedconversions', 'conversions'); 
        return true;
    });
    initBookedInput($(":input[name='impressions']"));
    initBookedInput($(":input[name='clicks']"));
    initBookedInput($(":input[name='conversions']"));
  });
	

//setup calendars
	Calendar.setup({
	    inputField : 'start',
	    ifFormat   : '%d %B %Y',
	    button     : 'start_button',
	    align      : 'Bl',
	    weekNumbers: false,
	    firstDay   : calendarBeginOfWeek,
	    electric   : false
	});
	
    Calendar.setup({
	   inputField : 'end',
	   ifFormat : '%d %B %Y',
	   button : 'end_button',
	   align : 'Bl',
	   weekNumbers: false,
	   firstDay : calendarBeginOfWeek,
	   electric : false
	});	

    function initBookedInput($input)
    {
      $input
        .focus(function() {
          max_formUnFormat(this.form, this.name);
          })
        .keypress(maskNonNumeric)
        .keyup(function() {
          max_formBookedUpdate(this.form);
          })
        .blur(function() {
          max_formFormat(this.form, this.name);
          max_formBookedUpdate(this.form);
          });
    }

    var previous_target = '';
    var previous_weight = '';
    var previous_priority = '';

    function phpAds_priorityCheck(f)
    {
        if (f.delivery[1].checked && !parseInt(f.target_value.value)) {
            return confirm (strCampaignWarningNoTargetMessage);
        }
        if (f.delivery[2].checked && !parseInt(f.weight.value)) {
            return confirm (strCampaignWarningNoWeightMessage);
        }
        return true;
    }

	function hasUnlimitedValue(input)
	{
	   return (input.value == '-') || (input.value == 0)
	}


	function setUnlimitedValue(input)
	{
	    input.value = "-";
	}

    function phpAds_formDateClick(o, value)
    {
{/literal}
        var date = eval ("document.{$campaignFormId}." + o + ".value");
{literal}        
        if (value == false) {
{/literal}
            eval ("document.{$campaignFormId}." + o + ".value = ''");
{literal}            
        }
        if (value == true && date == '') {
{/literal}
            eval ("document.{$campaignFormId}." + o + "Set[0].checked = true");
{literal}            
        }
        if (o == 'end') {
{/literal}
            phpAds_formPriorityUpdate(document.{$campaignFormId});
{literal}            
        }
    }

    function phpAds_formDateCheck(o)
    {
{/literal}
        var date = eval ("document.{$campaignFormId}." + o + ".value");
{literal}        
        if (date == '') {
{/literal}
            eval ("document.{$campaignFormId}." + o + "Set[0].checked = true");
{literal}            
        } else {
{/literal}
            eval ("document.{$campaignFormId}." + o + "Set[1].checked = true");
{literal}            
        }
        if (o == 'end') {
{/literal}
            phpAds_formPriorityUpdate(document.{$campaignFormId});
{literal}            
        }
    }

    function phpAds_activeRangeCheck(form)
    {
        var activeDate;
        var expireDate;
        var activation_enabled = isDateSetActive('start', form);
        var expiry_enabled = isDateSetActive('end', form);
        // No sense in comparing inactive values
        if (activation_enabled) {
            activateDate = newDateFromNamedFields(document, form, 'start');
            if (!activateDate) {
                alert('The start date of this campaign is not a valid date');
                return false;
            }
        }
        if(expiry_enabled) {
            expireDate = newDateFromNamedFields(document, form, 'end');
            if (!expireDate) {
                alert('The end date of this campaign is not a valid date');
                return false;
            }
        }
        if (activation_enabled && expiry_enabled) {
            if (!isDateEqual(activateDate, expireDate) && isDateBefore(expireDate, activateDate)) {
                alert('The selected dates for this campaign are invalid\n(Campaign ends before it starts!).\n');
                return false;
            }
        }
        return true;
    }

    function phpAds_formUnlimitedClick(oc,oe, remainingCentralId)
    {
        e = findObj(oe);
        c = findObj(oc);
        if (c.checked == true) {
            setUnlimitedValue(e);
            e.disabled = true;

{/literal}
            {if $adDirectEnabled}
                {literal}            
                //remove any "insufficient" error indicators
                    if (remainingCentralId != undefined && remainingCentralId != "") {
                      markInsufficient(false, remainingCentralId);
                    }
                {/literal}                    
            {/if}
{literal}                                
        } 
        else {
            e.value = "";
            e.disabled = false;
            e.focus();
        }
        // Update check
        max_formBookedUpdate(e.form);
    }


    function phpAds_formUnlimitedCheck(oc,oe)
    {
        e = findObj(oe);
        c = findObj(oc);
        if (hasUnlimitedValue(e)) {
            c.checked = true;
            e.disabled = true;
        } else {
            c.checked = false;
            e.disabled = false;
        }
        max_formBookedUpdate(e.form);
    }

    function phpAds_enableRadioButton(field_name, field_value, enabled)
    {
        var radio_group = findObj(field_name);
        for (var i = 0; i < radio_group.length; i++) {
            if (radio_group[i].value == field_value) {
                radio_group[i].disabled = !enabled;
                break;
            }
        }
    }


    function phpAds_enableSelect(field_name, enabled)
    {
        var obj = findObj(field_name);
        obj.disabled = !enabled;
    }

    function phpAds_enableTextField(field_name, previous_field, enabled)
    {
        var obj = findObj(field_name);
        if (enabled) {
            if (obj.disabled) {
                obj.value = previous_field;
                obj.disabled = !enabled;
            }
        } else {
            if (!obj.disabled) {
                previous_field = obj.value;
                obj.value = '-';
                obj.disabled = true;
            }
        }
        return previous_field;
    }

    function phpAds_formPriorityRadioClick(rd)
    {
        phpAds_formPriorityUpdate(rd.form);
    }

    function phpAds_formDeliveryRadioClick(rd)
    {
        phpAds_formPriorityUpdate(rd.form);
        if (rd.value == '1') {
            f.target_value.select();
            f.target_value.focus();
        } else if (rd.value == '0') {
            f.weight.select();
            f.weight.focus();
        }
    }

    function phpAds_setRemainingVisibility(elementId, visible) {
        var $elem = $("#" + elementId);

        if (visibility) {
            $elem.show();
        } else {
            $elem.hide();
        }
    }


    function max_formUnFormat(f, type)
    {
        if (type == 'impressions') {
            if (f.impressions.value != '-' && f.impressions.value != '') {
                f.impressions.value = max_formattedNumberStringToFloat(f.impressions.value);
            } else {
                f.impressions.value = '';
            }
        }

        if (type == 'clicks') {
            if (f.clicks.value != '-' && f.clicks.value != '') {
                f.clicks.value = max_formattedNumberStringToFloat(f.clicks.value);
            } else {
                f.clicks.value = '';
            }
        }
{/literal}                
{if $conversionsEnabled}
    {literal}
        if (type == 'conversions') {
            if (f.conversions.value != '-' && f.conversions.value != '') {
                f.conversions.value = max_formattedNumberStringToFloat(f.conversions.value);
            } else {
                f.conversions.value = '';
            }
        }
    {/literal}
{/if}
{literal}                
    }

    function max_formFormat(f, type)
    {
        if (type == 'impressions') {
            if ((f.impressions.value == '') || (f.impressions.value == 0)) {
                f.impressions.value = '-';
            }
            if (f.impressions.value != '-') {
                f.impressions.value = max_formatNumberIgnoreDecimals(f.impressions.value);
            }
        }
        if (type == 'clicks') {
            if ((f.clicks.value == '') || (f.clicks.value == 0)) {
                f.clicks.value = '-';
            }
            if (f.clicks.value != '-') {
                f.clicks.value = max_formatNumberIgnoreDecimals(f.clicks.value);
            }
        }
{/literal}                
{if $conversionsEnabled}
    {literal}
        if (type == 'conversions') {
            if ((f.conversions.value == '') || (f.conversions.value == 0)) {
                f.conversions.value = '-';
            }
            if (f.conversions.value != '-') {
                f.conversions.value = max_formatNumberIgnoreDecimals(f.conversions.value);
            }
        }
    {/literal}
{/if}
{literal}        
    }

    function max_formBookedUpdate(f)
    {
        // Update remaining impressions/click/conversions
        if (max_formattedNumberStringToFloat(f.impressions.value) >= 0) {
            var remaining = max_formattedNumberStringToFloat(f.impressions.value) - impressions_delivered;
            document.getElementById('remainingImpressionsCount').innerHTML = max_formatNumberIgnoreDecimals(remaining);
{/literal}
{if $adDirectEnabled}
            insufficientNumberCheck(remaining, centralImpressionsRemaining, 'openadsRemainingImpressions');
{/if}
{literal}        
            visibility = true;
        } 
        else {
            visibility = false;
        }
        phpAds_setRemainingVisibility('remainingImpressions', visibility);

        if (max_formattedNumberStringToFloat(f.clicks.value) >= 0) {
            var remaining = max_formattedNumberStringToFloat(f.clicks.value) - clicks_delivered;
            document.getElementById('remainingClicksCount').innerHTML = max_formatNumberIgnoreDecimals(remaining);
{/literal}
{if $adDirectEnabled}
             insufficientNumberCheck(remaining, centralClicksRemaining, 'openadsRemainingClicks');
{/if}
{literal}        
            visibility = true;
        } 
        else {
            visibility = false;
        }
        phpAds_setRemainingVisibility('remainingClicks', visibility);

{/literal}                
{if $conversionsEnabled}
    {literal}
        if (max_formattedNumberStringToFloat(f.conversions.value) >= 0) {
            var remaining = max_formattedNumberStringToFloat(f.conversions.value) - conversions_delivered;
            document.getElementById('remainingConversionsCount').innerHTML = max_formatNumberIgnoreDecimals(remaining);
            visibility = true;
        } else {
            visibility = false;
        }
    {/literal}
{/if}
{literal}
        phpAds_setRemainingVisibility('remainingConversions', visibility);

        phpAds_formPriorityUpdate(f);
    }
    

    function phpAds_formPriorityUpdate(f)
    {
        // Check to see if autotargeting is available. Autotargeting is
        // available when there is an expiration date and one of a set
        // number of target impressions, clicks or conversions
        var autotarget_available =  ( !(f.endSet[0].checked == true) &&
                                      (
                                        (!( isNaN(max_formattedNumberStringToFloat(f.impressions.value)) || (f.impressions.value == '') || (f.unlimitedimpressions.checked == true)))
                                        || (!( isNaN(max_formattedNumberStringToFloat(f.clicks.value))      || (f.clicks.value == '')      || (f.unlimitedclicks.checked == true)))
{/literal}                
{if $conversionsEnabled}
    {literal}
                                        || (!( isNaN(max_formattedNumberStringToFloat(f.conversions.value)) || (f.conversions.value == '') || (f.unlimitedconversions.checked == true)))
    {/literal}
{/if}
{literal}
                                      )
                                    );
        // When autotargeting is available, only High-Priority
        // campaigns possible; disable Low and Exclusive campaign
        // buttons, and check the High-Priorty campaign button
        f.priority[0].disabled = autotarget_available;
        f.priority[1].disabled = false;
        if (autotarget_available) {
            f.priority[1].checked = true;
        }
        f.priority[2].disabled = autotarget_available;
        // If an Exclusive campaign
        if (!f.priority[0].disabled && f.priority[0].checked) {
            phpAds_enableRadioButton('delivery', 'auto', false);
            phpAds_enableRadioButton('delivery', 'manual', false);
            phpAds_enableRadioButton('delivery', 'none', true);
            phpAds_enableSelect('high_priority_value', false);
            phpAds_enableSelect('target_type', false);
        }
        // If a High-Priority campaign
        if (!f.priority[1].disabled && f.priority[1].checked) {
            phpAds_enableRadioButton('delivery', 'auto', autotarget_available);
            phpAds_enableRadioButton('delivery', 'manual', !autotarget_available);
            phpAds_enableRadioButton('delivery', 'none', false);
            phpAds_enableSelect('high_priority_value', true);
            phpAds_enableSelect('target_type', !autotarget_available);
        }
        // If a Low-Priority campaign
        if (!f.priority[2].disabled && f.priority[2].checked) {
            phpAds_enableRadioButton('delivery', 'auto', false);
            phpAds_enableRadioButton('delivery', 'manual', false);
            phpAds_enableRadioButton('delivery', 'none', true);
            phpAds_enableSelect('high_priority_value', false);
            phpAds_enableSelect('target_type', false);
        }
        // If a checked priority radio button has been disabled
        if ( (f.priority[0].checked && f.priority[0].disabled) ||
             (f.priority[1].checked && f.priority[1].disabled) ||
             (f.priority[2].checked && f.priority[2].disabled) ) {
            // Try to set the right radio button
            if (!f.priority[0].disabled) {
                f.priority[0].checked = true;
            } else if (!f.priority[1].disabled) {
                f.priority[1].checked = true;
            } else if (!f.priority[2].disabled) {
                f.priority[2].checked = true;
            }
        }
        // If a checked distribution radio button has been disabled
        if ( (f.delivery[0].checked && f.delivery[0].disabled) ||
             (f.delivery[1].checked && f.delivery[1].disabled) ||
             (f.delivery[2].checked && f.delivery[2].disabled) ) {
            // Try to set the right radio button
            if (!f.delivery[0].disabled) {
                f.delivery[0].checked = true;
            } else if (!f.delivery[1].disabled) {
                f.delivery[1].checked = true;
            } else if (!f.delivery[2].disabled) {
                f.delivery[2].checked = true;
                // As selecting the weight-based distribution, set
                // the weight to a default of 1, if not already set
                if ((previous_weight == '-') || (previous_weight == 0)) {
                    previous_weight = 1;
                }
            }
        }
        // Only enable target/weight if their radio buttons are checked.
        var len = f.delivery.length;
        for (var i = 0; i < f.delivery.length; i++) {
            if (!f.delivery[i].disabled && f.delivery[i].checked) {
                if (f.delivery[i].value == 'auto') {
                    previous_target = phpAds_enableTextField('target_value', previous_target, false);
                    previous_weight = phpAds_enableTextField('weight', previous_weight, false);
                } 
                else if (f.delivery[i].value == 'manual') {
                    previous_target = phpAds_enableTextField('target_value', previous_target, true);
                    previous_weight = phpAds_enableTextField('weight', previous_weight, false);
                } 
                else if (f.delivery[i].value == 'none') {
                    previous_target = phpAds_enableTextField('target_value', previous_target, false);
                    previous_weight = phpAds_enableTextField('weight', previous_weight, true);
                }
                break;
            }
        }
    }
    
    $(document).ready(function() {
{/literal}
        $("#{$campaignFormId}").submit(
{literal}        
            function() {
		        max_formUnFormat(this, 'impressions');
		        max_formUnFormat(this, 'clicks');
		        max_formUnFormat(this, 'conversions');
            
                return phpAds_priorityCheck(this) 
                    &&  phpAds_activeRangeCheck(this);
        });
    });
{/literal}    
    
    // Format the target numbers on page load
    max_formFormat(document.{$campaignFormId}, 'impressions');
    max_formFormat(document.{$campaignFormId}, 'clicks');
    max_formFormat(document.{$campaignFormId}, 'conversions');

    // Display remaining target data on page load
    max_formBookedUpdate(document.{$campaignFormId});
	
    //-->
 </script>
